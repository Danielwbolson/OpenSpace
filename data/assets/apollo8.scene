local assetHelper = asset.require('util/asset_helper')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')

asset.require('spice/base')
assetHelper.requestAll(asset, 'scene/solarsystem/sun')
asset.require('scene/solarsystem/planets')
asset.request('scene/digitaluniverse/stars')
asset.request('scene/digitaluniverse/milkyway')
--assetHelper.requestAll(asset, 'scene/digitaluniverse')

-- Load default key bindings applicable to most scenes
asset.require('util/default_keybindings')
asset.require('util/default_dashboard')

asset.request('customization/globebrowsing')

asset.require('scene/solarsystem/missions/apollo/apollo8')
asset.require('scene/solarsystem/missions/apollo/apollo_11_lem_flipbook')
asset.require('scene/solarsystem/missions/apollo/insignias_map')

asset.require('util/webgui')


-- Custom Keybindings
local Keybindings = {
    {
        Key = "END",
        Command = "openspace.sessionRecording.stopRecording();\n",
        Documentation = "Stops session recording",
        Local = false
    },
    {
        Key = "U",
        Command =   "openspace.time.setTime('1968-12-21T15:41:37.00')" ..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo8');" ..
                    "openspace.setPropertyValueSingle('Scene.Apollo8LaunchTrail.Renderable.Enabled', true);",
        Documentation = "Jump to time right before A8 liftoff",
        Local = false
    },
    {
        Key = "E",
        Command =   "openspace.time.setPause(true);" ..
                    'openspace.time.setTime("1968 DEC 24 16:37:31");' ..
                    'openspace.navigation.setCameraState({' ..
                        'Anchor = "Apollo8Pivot",' ..
                        'Aim = "",' ..
                        'Position = { 12.94543, 17.25316, -23.16316 },' ..
                        'Rotation = { -0.0996527, 0.727683, 0.615566, 0.285701 },' ..
                    '});',
        Documentation = "Jump to right before the earthrise photo",
        Local = false
    },
    {
        Key = "SHIFT+E",
        Command =   "openspace.time.setPause(true);" ..
                    'openspace.time.setTime("1968 DEC 24 16:38:43");'  ..
                    'openspace.navigation.setCameraState({'  ..
                    '    Anchor = "Apollo8Pivot",'  ..
                    '    Aim = "",' ..
                    '    Position = { 0.00863647, -1.014866, -0.747894 },'  ..
                    '    Rotation = { -0.123114, 0.695592, 0.655970, 0.265891 }'  ..
                    '});',
        Documentation = "Jump to time and place of main earthrise photo",
        Local = false
    },
    {
        Key = "K",
        Command = propertyHelper.invert('Scene.Moon.Renderable.Layers.ColorLayers.Kaguya_Utah.Enabled'),
        Documentation = "Toggles Moon Kaguya color layer",
        Local = false
    },
    {
        Key = "T",
        Command = propertyHelper.invert('Scene.Apollo8MoonTrail.Renderable.Enabled'),
        Documentation = "Toggles the Apollo 8 trail when orbiting the Moon",
        Local = false
    },
    {
        Key = "SHIFT+T",
        Command = propertyHelper.invert('Scene.Apollo8LaunchTrail.Renderable.Enabled'),
        Documentation = "Toggles the Apollo 8 trail related to the launch",
        Local = false
    },
    {
        Key = "CTRL+T",
        Command = propertyHelper.invert('Scene.Apollo8EarthBarycenterTrail.Renderable.Enabled'),
        Documentation = "Toggles the full Apollo 8 trail relative to Earth's barycenter",
        Local = false
    },
    {
        Key = "J",
        Command =   "openspace.setPropertyValue('Scene.*Trail.Renderable.Enabled', true)",
        Documentation = "Enables visibility of the trails",
        Local = false
    },
    {
        Key = "S",
        Command = propertyHelper.invert('Scene.Moon.Renderable.PerformShading'),
        Documentation = "Toggles shading for the moon",
        Local = false
    },
    {
        Key = "PAGE_UP",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo8');",
        Documentation = "Focus on Apollo 8",
        Local = false
    },
    {
        Key = "PAGE_DOWN",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Moon');",
        Documentation = "Focus on moon",
        Local = false
    },
    {
        Key = "HOME",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Earth');",
        Documentation = "Focus on Earth",
        Local = false
    },
    {
        Key = "h",
        Name="Hide Trails",
        Command = "openspace.setPropertyValue('Scene.*Trail.Renderable.Enabled', false)",
        Documentation = "Disables visibility of the trails",
        GuiPath = "/Rendering",
        Local = false
    },

}


asset.onInitialize(function ()
    -- Launch time:
    openspace.time.setTime("1968-12-21T12:51:51.0")

    -- Earthrise:
    -- openspace.time.setTime("1968-12-24T16:37:19.0")

    sceneHelper.bindKeys(Keybindings)

    openspace.setDefaultGuiSorting()

    sceneHelper.setDeltaTimeKeys({
      1, 5, 10, 20, 40, 90, 360, 720, 2880, 14400,
      28800, 57600, 115200, 230400, 460800, 921600, 1843200, 3686400, 7372800, 14745600
    })

    openspace.markInterestingNodes({
        "Earth", "Moon", "Apollo8Pivot", "Apollo8"
    })

    openspace.addVirtualProperty(
        "BoolProperty",
        "Show Trails",
        "Scene.*Trail.Renderable.Enabled",
        "Disable or enable all trails of the scene at the same time",
        true,
        nil,
        nil
    )

    openspace.setPropertyValueSingle('Modules.ImGUI.Main.ShowHelpText', false);
    openspace.setPropertyValueSingle('RenderEngine.Background Exposure', 5.0);
    openspace.setPropertyValueSingle('Scene.MilkyWay.Renderable.Opacity', 0.11);
    openspace.setPropertyValueSingle('Scene.Earth.Renderable.Layers.ColorLayers.ESRI_VIIRS_Combo.Settings.Gamma', 1.85);
    openspace.setPropertyValueSingle('Scene.Stars.Renderable.ScaleFactor', 0.84);
    openspace.setPropertyValueSingle('NavigationHandler.OrbitalNavigator.MinimumAllowedDistance', 0.000000);
    openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.Kaguya_Utah.BlendMode', 4);
    openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.Kaguya_Utah.Settings.Multiplier', 1.084750);
    openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.WAC_Utah.BlendMode', 4);

    openspace.navigation.setCameraState({
        Anchor = "Earth",
        Position = { 0, 0, 0 },
        Rotation = { 0.758797, 0.221490, -0.605693, -0.091135 },
    })

    openspace.globebrowsing.goToGeo(28.5729, 80.6490, 20000000)
end)

asset.onDeinitialize(function ()
    openspace.removeVirtualProperty("*Trail.renderable.Enabled")
    openspace.removeInterestingNodes({
        "Earth", "Moon", "Apollo8Pivot", "Apollo8"
    })
end)