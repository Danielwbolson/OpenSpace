--apollo.scene (recreates the apollo 8 and 15 missions from available spice data)
asset.require('./base')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')

-- local station2 = asset.require('scene/solarsystem/missions/apollo/bouldersstation2')
-- local station6 = asset.require('scene/solarsystem/missions/apollo/bouldersstation6')
-- local station7 = asset.require('scene/solarsystem/missions/apollo/bouldersstation7')
asset.require('scene/solarsystem/missions/apollo/apollo8')
asset.require('scene/solarsystem/missions/apollo/apollo11')
asset.require('scene/solarsystem/missions/apollo/apollo15')
asset.require('scene/solarsystem/missions/apollo/apollo17_lem')
asset.require('scene/solarsystem/missions/apollo/apollo_globebrowsing')
asset.require('scene/solarsystem/missions/apollo/apollo_11_lem_flipbook')
asset.require('scene/solarsystem/missions/apollo/insignias_map')

local Keybindings = {
    {
        Key = "m",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Moon'); " ..
                  "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);",
        Documentation = "Focus on Moon",
        Name = "Focus on Moon",
        GuiPath = "/Missions/Apollo",
        Local = false
    },
     {
        Key = "F9",
        Command = "openspace.setPropertyValue('Scene.Moon.Renderable.Layers.ColorLayers.A17_*.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_11.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A11_M177481212_p_longlat.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo11MoonTrail.Renderable.Enabled', false);" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo11LemTrail.Renderable.Enabled', false);"..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', false);",
        Documentation = "Disable apollo site on moon when switching",
        Name = "Disable Apollo site",
        GuiPath = "/Missions/Apollo",
        Local = false
    },
    {
        Key = "F11",
        Command = "openspace.time.setTime('1969 JUL 20 20:17:40');" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_11.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A11_M177481212_p_longlat.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.LodScaleFactor', 20.11);" ..
                  "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo11LemPosition');" ..
                  "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo11MoonTrail.Renderable.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Apollo11LemTrail.Renderable.Enabled', true);",
        Documentation = "Setup for A11 site",
        Name = "Setup A11 site",
        GuiPath = "/Missions/Apollo/11",
        Local = false
    },
    {
        Key = "F7",
        Command = "openspace.time.setTime('1972 DEC 12 19:47:11');" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.BlendMode', 0.000000);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', true);" ..
                  -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station6a.Enabled', true);" ..
                  -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station6a.BlendMode', 0.000000);" ..
                  -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station2.Enabled', true);" ..
                  -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station2.BlendMode', 0.000000);" ..
                  -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station7.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.BlendMode', 0.000000);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.Enabled', true);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.BlendMode', 0.000000);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.LodScaleFactor', 20.17);" ..
                  "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo17LemModel');" ..
                  "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);" ..
                  "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station7.BlendMode', 0.000000);",
        Documentation = "Setup for A17 site",
        Name = "Setup A17 site",
        GuiPath = "/Missions/Apollo/17",
        Local = false
    },
    {
        Key = "E",
        Command = "openspace.time.setPause(true);" ..
                  "openspace.time.setDeltaTime(1);" ..
                  "openspace.time.setTime('1968 DEC 24 16:37:31');" ..
                  "openspace.navigation.setNavigationState({" ..
                  "    Anchor = 'Apollo8'," ..
                  "    Position = { 1.494592E1, 3.236777E1, -4.171296E1 }," ..
                  "    ReferenceFrame = 'Root'," ..
                  "    Up = { 0.960608E0, -0.212013E0, 0.179675E0 }" ..
                  "});" ..
                  "openspace.setPropertyValue('*Trail.Renderable.Enabled', false)",
        Documentation = "Jump to right before the earthrise photo",
        Name = "Set Earthrise time",
        GuiPath = "/Missions/Apollo/8",
        Local = false
    },
    {
        Key = "U",
        Command =   "openspace.time.setTime('1968-12-21T12:51:37.00')" ..
                    "openspace.setPropertyValueSingle('Scene.Apollo8LaunchTrail.Renderable.Enabled', true);",
        Documentation = "Jump to time right before Apollo 8 liftoff, with its trail enabled",
        Name = "Set Apollo 8 launch time",
        GuiPath = "/Missions/Apollo/8",
        Local = false
    },
    {
        Key = "T",
        Command = propertyHelper.invert('Scene.Apollo8MoonTrail.Renderable.Enabled'),
        Documentation = "Toggles the trails of the Apollo 8 orbits, focused around the Moon",
        Name = "Toggle Apollo 8 orbits",
        GuiPath = "/Missions/Apollo/8",
        Local = false
    },
    {
        Key = "SHIFT+T",
        Command = propertyHelper.invert('Scene.Apollo8LaunchTrail.Renderable.Enabled'),
        Documentation = "Toggles the trails of the Apollo 8 Launch, focused around the Earth",
        Name = "Toggle Apollo 8 launch trail",
        GuiPath = "/Missions/Apollo/8",
        Local = false
    },
    {
        Key = "CTRL+T",
        Command = propertyHelper.invert('Scene.Apollo8EarthBarycenterTrail.Renderable.Enabled'),
        Documentation = "Toggles the trails of the full Apollo 8, with Earth's frame of reference",
        Name = "Toggles Apollo 8 full trail",
        GuiPath = "/Missions/Apollo/8",
        Local = false
    },
    {
        Key = "S",
        Command = propertyHelper.invert('Scene.Moon.Renderable.PerformShading'),
        Documentation = "Toggles shading for the Moon",
        Name = "Toggle Moon shading",
        GuiPath = "/Missions/Apollo",
        Local = false
    }
}



local moonAsset = asset.require('scene/solarsystem/planets/earth/moon/moon')
asset.onInitialize(function ()
    openspace.time.setTime("1972 DEC 12 19:47:11")

    sceneHelper.bindKeys(Keybindings)

    openspace.markInterestingNodes({
      "Moon", "Apollo11LemModel", "Apollo17LemModel",
      "Apollo11", "Apollo11LunarLander",  "Apollo8", "Apollo8Launch"
      -- "Station_2_Boulder2",  "Station_6_Fragment1"
    })

    openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.BlendMode', 0);
    -- To enable both sites by default, uncomment these lines
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.Enabled', true);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', true);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.Enabled', true);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.BlendMode', 0.000000);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.Enabled', true);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.BlendMode', 0.000000);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station7.BlendMode', 0.000000);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_11.Enabled', true);
    -- openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A11_M177481212_p_longlat.Enabled', true);

    openspace.setPropertyValueSingle('Scene.Apollo11LemDescentModel.Renderable.RotationVector', { 273.750,28.0,309.85 });
    openspace.setPropertyValueSingle('Scene.Apollo11LemLandedModel.Renderable.RotationVector', { 273.750,28.0,309.85 });

    openspace.globebrowsing.goToGeo(moonAsset.Moon.Identifier, 20, -60, 15000000)

    openspace.setPropertyValueSingle("Scene.Moon.Renderable.PerformShading", false)
end)

asset.onDeinitialize(function ()
    openspace.removeInterestingNodes({
      "Moon", "Apollo11Lem", "Apollo17Lem",
      "Apollo11", "Apollo11LemPosition", "Apollo8", "Apollo8Launch"
      -- "Station_6_Fragment1", "Station_6_Fragments_2_3"
    })
end)
