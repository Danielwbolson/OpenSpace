local assetHelper = asset.require('util/asset_helper')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')
local renderableHelper = asset.require('util/renderable_helper')

-- Specifying which other assets should be loaded in this scene
asset.require('spice/base')
assetHelper.requestAll(asset, 'scene/solarsystem/sun')
-- asset.require('scene/solarsystem/planets')
-- asset.require('scene/solarsystem/planets/mars/moons/phobos')
-- asset.require('scene/solarsystem/planets/mars/moons/deimos')
-- asset.require('scene/solarsystem/dwarf_planets/pluto/system')
-- assetHelper.requestAll(asset, 'scene/digitaluniverse')

-- Load default key bindings applicable to most scenes
asset.require('util/default_keybindings')
asset.require('util/default_dashboard')
-- asset.require('util/default_joystick')

-- DEBUG
-- asset.require('./testwsa/debugcoordaxes');
local webGui = asset.require('util/webgui')

-- asset.request('customization/globebrowsing')

-- local earthAsset = asset.require('scene/solarsystem/planets/earth/earth')
local sunAsset = asset.require('scene/solarsystem/sun/sun')

local sunRadius = 695508000

local earthRadius = 6371

-- Selected field lines + some additional field lines
-- asset.require('./wsa/scs_oi')
-- asset.require('./wsa/pfss_oi')
-- asset.require('./wsa/pfss_io')
-- Sub-Earth track
-- asset.require('./wsa/sub_earth')
-- Sun with magnetic field texture
-- local sunAsset = asset.require('./wsa/sun')

-- Parker Solar Probe asset package
-- asset.require('scene/solarsystem/missions/parkersolarprobe/parker_solar_probe_trail')
-- asset.require('./wsa/psp_pfss_io')
-- asset.require('./wsa/psp_pfss_oi')
-- asset.require('./wsa/psp_scs_oi')
-- asset.require('./wsa/psp_sub_satellite')




local Keybindings = {
    {
        Key = "j",
        Command = renderableHelper.toggle('Scene.PspMarker'),
        Documentation = "Toggles wether the parker solar probe marker is active or not",
        Name = "Toggle Parker solar probe marker",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "p",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'PspPosition');" ..
        "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil)",
        Documentation = "Set the target to parker solar probe",
        Name = "Anchor at Parker solar probe, Aim at the sun",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "o",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Sun');" ..
        "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil)",
        Documentation = "Set the target to the Sun",
        Name = "Anchor to the sun, target the probe",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "i",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Earth');" ..
        "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil)",
        Documentation = "Set the target to Earth",
        Name = "Anchor to Earth, target the Sun",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "k",
        Command = renderableHelper.toggle('Scene.WSA_Fieldlines_PFSS_IO') ..
        renderableHelper.toggle('Scene.WSA_Fieldlines_PFSS_OI') ..
        renderableHelper.toggle('Scene.WSA_Fieldlines_SCS_OI') ..
        renderableHelper.toggle('Scene.WSA_Fieldlines_Sub_Earth_Track'),
        Documentation = "Toggle all fieldlines in the scene",
        Name = "Toggle all field lines",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "z",
        Command = "openspace.time.setTime('2017 SEP 1 00:00:00.000')",
        Documentation = "Jump to 1 September 2017",
        Name = "Jump to 2017",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "x", 
        Command = "openspace.time.setTime('2018 NOV 1 00:00:00.000')",
        Documentation = "Jump to 1 November 2018",
        Name = "Jump to 1 November 2018",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "b",
        Command = renderableHelper.toggle('Scene.WSA_Fieldlines_Sub_Earth_Track'),
        Documentation = "Toggle ballerina skirt",
        Name = "Toggle Sub Earth connection",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "v",
        Command = renderableHelper.toggle('Scene.WSA_Fieldlines_PFSS_IO')..
        renderableHelper.toggle('Scene.PSP_WSA_Fieldlines_PFSS_IO'),
        Documentation = "Toggle PFSS in to out model",
        Name = "Toggle PFSS in to out model",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "n",
        Command = renderableHelper.toggle('Scene.WSA_Fieldlines_PFSS_OI') ..
        renderableHelper.toggle('Scene.PSP_WSA_Fieldlines_PFSS_OI'),
        Documentation = "Toggle PFSS out to in model",
        Name = "Toggle PFSS out to in model",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "m",
        Command = renderableHelper.toggle('Scene.WSA_Fieldlines_SCS_OI') ..
        renderableHelper.toggle('Scene.PSP_WSA_Fieldlines_SCS_OI'),
        Documentation = "Toggle SCS out to in model",
        Name = "Toggle SCS out to in model",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "l", 
        Command = "openspace.setPropertyValue('Scene.WSA_Fieldlines_SCS_OI.Renderable.Masking.maskingQuantity', 1)" ..
        "openspace.setPropertyValue('Scene.WSA_Fieldlines_SCS_OI.Renderable.maskingEnabled', not openspace.getPropertyValue('Scene.WSA_Fieldlines_SCS_OI.Renderable.maskingEnabled'))" ..
        "openspace.setPropertyValue('Scene.WSA_Fieldlines_PFSS_OI.Renderable.Masking.maskingQuantity', 1)" ..
        "openspace.setPropertyValue('Scene.WSA_Fieldlines_PFSS_OI.Renderable.maskingEnabled', not openspace.getPropertyValue('Scene.WSA_Fieldlines_PFSS_OI.Renderable.maskingEnabled'));" ..
        "openspace.setPropertyValue('Scene.PSP_WSA_Fieldlines_SCS_OI.Renderable.Masking.maskingQuantity', 1)" ..
        "openspace.setPropertyValue('Scene.PSP_WSA_Fieldlines_SCS_OI.Renderable.maskingEnabled', not openspace.getPropertyValue('Scene.PSP_WSA_Fieldlines_SCS_OI.Renderable.maskingEnabled'))" ..
        "openspace.setPropertyValue('Scene.PSP_WSA_Fieldlines_PFSS_OI.Renderable.Masking.maskingQuantity', 1)" ..
        "openspace.setPropertyValue('Scene.PSP_WSA_Fieldlines_PFSS_OI.Renderable.maskingEnabled', not openspace.getPropertyValue('Scene.PSP_WSA_Fieldlines_PFSS_OI.Renderable.maskingEnabled'));",
        Documentation = "Toggle current sheet in all out to in models",
        Name = "Toggle current sheet in all out to in models",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
        {
        Key = "h", 
        Command = "openspace.setPropertyValue('Scene.WSA_Fieldlines_Sub_Earth_Track.Renderable.Masking.maskingQuantity', 1)" ..
                "openspace.setPropertyValue('Scene.WSA_Fieldlines_Sub_Earth_Track.Renderable.maskingEnabled', true);",
        Documentation = "Show only one layer of sub earth track",
        Name = "Toggle sub satellite layers",
        GuiPath = "/Parker Solar Probe",
        Local = false
    },
    {
        Key = "Shift+g",
        Command = "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Earth');" ..
        "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil)" ..
        "openspace.globebrowsing.goToGeo(38.995412,-76.857665)",
        Documentation = "Sets the focus of the camera on 'Goddard'",
        Local = false
    },
}

asset.onInitialize(function ()
    webGui.setCefRoute("onscreen")

    local now = openspace.time.currentWallTime()
    sceneHelper.bindKeys(Keybindings)
    -- Sun magnetogram texture testing
    openspace.time.setTime("2017 JUL 1 04:00:00.000")
    
    -- Set different deltatimes
    sceneHelper.setDeltaTimeKeys({
        1, 3600, 430000
    })

    openspace.setDefaultGuiSorting()

    --openspace.globebrowsing.loadWMSServersFromFile(
    --    openspace.absPath("${DATA}/globebrowsing_servers.lua")
    --)

    openspace.addVirtualProperty(
        "BoolProperty",
        "Show Trails",
        "Scene.*Trail.Renderable.Enabled",
        "Disable or enable all trails of the scene at the same time",
        true,
        nil,
        nil
    )

    openspace.markInterestingNodes({
        "Earth", "Sun", "Moon", "PspPosition" --, "MAS_MHD_Fieldlines"
    })

    -- Place by the sun
    openspace.navigation.setNavigationState({
        Anchor = sunAsset.Sun.Identifier,
        Position = { 8*sunRadius, 8*sunRadius, 0 },
        Rotation = { 0.0, 0.0, 0.7, 0.0 },
    })


end)

asset.onDeinitialize(function ()

    openspace.removeVirtualProperty("*Trail.Renderable.Enabled")
end)
