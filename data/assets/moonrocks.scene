--moonrocks.scene
local assetHelper = asset.require('util/asset_helper')
local sceneHelper = asset.require('util/scene_helper')
local propertyHelper = asset.require('util/property_helper')

-- Specifying which other assets should be loaded in this scene
asset.require('spice/base')

assetHelper.requestAll(asset, 'scene/solarsystem/sun')
asset.require('scene/solarsystem/planets')
asset.require('scene/solarsystem/planets/mars/moons/phobos')
asset.require('scene/solarsystem/planets/mars/moons/deimos')
asset.require('scene/solarsystem/dwarf_planets/pluto/system')
assetHelper.requestAll(asset, 'scene/digitaluniverse')

-- Load default key bindings applicable to most scenes
asset.require('util/default_keybindings')
asset.require('util/default_dashboard')
asset.require('util/default_joystick')

asset.request('customization/globebrowsing')
asset.require('util/webgui')


local earthAsset = asset.require('scene/solarsystem/planets/earth/earth')
local moonAsset = asset.require('scene/solarsystem/planets/earth/moon/moon')

local station2 = asset.require('scene/solarsystem/missions/apollo/bouldersstation2')
local station6 = asset.require('scene/solarsystem/missions/apollo/bouldersstation6')
local station7 = asset.require('scene/solarsystem/missions/apollo/bouldersstation7')
local a11lem = asset.require('scene/solarsystem/missions/apollo/a11_lem')
local a17lem = asset.require('scene/solarsystem/missions/apollo/a17_lem')
local layers = asset.require('scene/solarsystem/missions/apollo/apollo_globebrowsing')
local flipbook = asset.require('scene/solarsystem/missions/apollo/apollo_11_lem_flipbook')

local Keybindings = {
    {
        Key = "H",
        Command =   "openspace.setPropertyValueSingle('Scene.EarthTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.EarthTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.JupiterTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.DeimosTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.MarsTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.PhobosTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.MercuryTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.NeptuneTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.TritonTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.SaturnTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.UranusTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.MoonTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.StyxTrail.Renderable.Enabled', false);" ..
                    "openspace.setPropertyValueSingle('Scene.PlutoBarycenterTrail.Renderable.Enabled', false); " ..
                    "openspace.setPropertyValueSingle('Scene.PlutoBarycentricTrail.Renderable.Enabled', false); " ..
                    "openspace.setPropertyValueSingle('Scene.CharonBarycentricTrail.Renderable.Enabled', false); "..
                    "openspace.setPropertyValueSingle('Scene.NixTrail.Renderable.Enabled', false); "..
                    "openspace.setPropertyValueSingle('Scene.KerberosTrail.Renderable.Enabled', false); "..
                    "openspace.setPropertyValueSingle('Scene.HydraTrail.Renderable.Enabled', false); "..
                    "openspace.setPropertyValueSingle('Scene.CharonBarycentricTrail.Renderable.Enabled', false); "..
                    "openspace.setPropertyValueSingle('Scene.VenusTrail.Renderable.Enabled', false);",
        Documentation = "Hide all trails",
        Local = false
    },
    {
        Key = "J",
        Command =   "openspace.setPropertyValueSingle('Scene.EarthTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.EarthTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.JupiterTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.DeimosTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.MarsTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.PhobosTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.MercuryTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.NeptuneTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.TritonTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.SaturnTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.UranusTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.MoonTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.StyxTrail.Renderable.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.PlutoBarycenterTrail.Renderable.Enabled', true); " ..
                    "openspace.setPropertyValueSingle('Scene.PlutoBarycentricTrail.Renderable.Enabled', true); " ..
                    "openspace.setPropertyValueSingle('Scene.CharonBarycentricTrail.Renderable.Enabled', true); "..
                    "openspace.setPropertyValueSingle('Scene.NixTrail.Renderable.Enabled', true); "..
                    "openspace.setPropertyValueSingle('Scene.KerberosTrail.Renderable.Enabled', true); "..
                    "openspace.setPropertyValueSingle('Scene.HydraTrail.Renderable.Enabled', true); "..
                    "openspace.setPropertyValueSingle('Scene.CharonBarycentricTrail.Renderable.Enabled', true); "..
                    "openspace.setPropertyValueSingle('Scene.VenusTrail.Renderable.Enabled', true);",
        Documentation = "Show all trails",
        Local = false
    },
    {
        Key = "m",
        Command =   "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Moon'); " ..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);",
        Documentation = "Focus on Moon",
        Name = "Focus on Moon",
        GuiPath = "/Missions/Apollo",
        Local = false
    },
    {
        Key = "F11",
        Command =   "openspace.time.setTime('1969 JUL 20 20:17:40');" .. 
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_11.Enabled', true);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A11_M177481212_p_longlat.Enabled', true);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.LodScaleFactor', 20.11);" ..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo11Lem');"..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);",
        Documentation = "Setup for A11 site",
        Name = "Setup A11 layers",
        GuiPath = "/Missions/Apollo/11",
        Local = false
    },
    {
        Key = "F7",
        Command =   "openspace.time.setTime('1972 DEC 12 19:47:11');" .. 
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.BlendMode', 0.000000);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_travmap.Enabled', true);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', true);"..
                    -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station6a.Enabled', true);"..
                    -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station6a.BlendMode', 0.000000);"..
                    -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station2.Enabled', true);"..
                    -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station2.BlendMode', 0.000000);"..
                    -- "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station7.Enabled', true);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_LEM.BlendMode', 0.000000);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.Enabled', true);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_NAC_Alt_p.BlendMode', 0.000000);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.LodScaleFactor', 20.17);" ..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', 'Apollo17Lem'); "..
                    "openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', nil);" ..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.ColorLayers.A17_station7.BlendMode', 0.000000);",
        Documentation = "Setup for A17 site",
        Name = "Setup A17 layers",
        GuiPath = "/Missions/Apollo/17",
        Local = false
    },
    {
        Key = "SHIFT+F7",
        Command =   "openspace.setPropertyValue('Scene.Moon.Renderable.Layers.ColorLayers.A17_*.Enabled', false);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.Layers.HeightLayers.LRO_NAC_Apollo_17.Enabled', false);"..
                    "openspace.setPropertyValueSingle('Scene.Moon.Renderable.LodScaleFactor', 20.117);",
        Documentation = "Setup for A17 site",
        Name = "Setup A17 layers",
        GuiPath = "/Missions/Apollo/17",
        Local = false
    },
}


asset.onInitialize(function ()
    local now = openspace.time.currentWallTime()
    -- Jump back one day to show a complete planet
    openspace.time.setTime("1972 DEC 12 19:47:11")

    sceneHelper.bindKeys(Keybindings)
    openspace.setDefaultGuiSorting()

    openspace.globebrowsing.loadWMSServersFromFile(
        openspace.absPath("${DATA}/globebrowsing_servers.lua")
    )

    openspace.markInterestingNodes({
        "Moon",
    })

    openspace.addVirtualProperty(
        "BoolProperty",
        "Show Trails",
        "Scene.*Trail.renderable.Enabled",
        "Disable or enable all trails of the scene at the same time",
        true,
        nil,
        nil
    )

    -- openspace.navigation.setCameraState({
    --     Anchor = moonAsset.Moon.Identifier,
    --     Position = { 0, 0, 0 },
    --     Rotation = { 0, 0, 0, 0 },
    -- })

    openspace.setPropertyValueSingle("NavigationHandler.OrbitalNavigator.Aim", '')
    openspace.setPropertyValueSingle("NavigationHandler.OrbitalNavigator.Anchor", 'Moon')
    openspace.setPropertyValueSingle("NavigationHandler.OrbitalNavigator.RetargetAnchor", nil)

    openspace.globebrowsing.goToGeo("Earth", 20, -60, 15000000)

    openspace.setPropertyValueSingle("Scene.Moon.Renderable.PerformShading", false)
end)

asset.onDeinitialize(function ()

    openspace.removeVirtualProperty("*Trail.renderable.Enabled")

    openspace.removeInterestingNodes({
        "Moon",
    })
end)